// Link AI Newsletter Engine - Database Schema
// Multi-tenant Newsletter as a Service (NaaS) Platform

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// ==================== MULTI-TENANCY ====================

model Organization {
  id       String   @id @default(cuid())
  name     String
  slug     String   @unique
  plan     Plan     @default(FREE)
  industry Industry @default(TECHNOLOGY)
  logoUrl  String?

  // Billing/limits
  subscriberLimit    Int @default(1000)
  currentSubscribers Int @default(0)

  // Custom domain (Enterprise)
  customDomain String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - all tenant-scoped data
  members      OrgUser[]
  invites      OrgInvite[]
  settings     OrgSettings?
  articles     Article[]
  projects     Project[]
  editions     Edition[]
  subscribers  Subscriber[]
  rssSources   RSSSource[]
  curationJobs CurationJob[]
  templates    EmailTemplate[]
  brandVoices  BrandVoice[]
  mediaAssets  MediaAsset[]
  searchTopics SearchTopic[]

  @@index([slug])
  @@index([plan])
}

enum Plan {
  FREE // 1,000 subscribers, RSS curation, basic templates
  STARTER // 5,000 subscribers, + Ghost Writer
  PROFESSIONAL // 25,000 subscribers, + Trend Radar, personalization, API
  ENTERPRISE // Unlimited, + custom domain, white-label
}

enum Industry {
  TECHNOLOGY
  FINANCE
  INSURANCE
  HEALTHCARE
  RETAIL
  UTILITIES
  MANUFACTURING
  PROFESSIONAL_SERVICES
  OTHER
}

// Links Supabase auth users to organizations
model OrgUser {
  id             String  @id @default(cuid())
  supabaseUserId String // Supabase auth.users.id
  email          String
  name           String?
  role           OrgRole @default(VIEWER)

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supabaseUserId, organizationId])
  @@index([supabaseUserId])
  @@index([organizationId])
  @@index([email])
}

enum OrgRole {
  OWNER // Full access, can delete org
  ADMIN // Manage members, settings
  EDITOR // Manage content, send newsletters
  VIEWER // Read-only access
}

model OrgInvite {
  id        String   @id @default(cuid())
  email     String
  role      OrgRole  @default(EDITOR)
  token     String   @unique @default(cuid())
  expiresAt DateTime

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())

  @@unique([email, organizationId])
  @@index([token])
  @@index([organizationId])
}

// Per-organization settings (replaces global Settings for org-specific config)
model OrgSettings {
  id String @id @default(cuid())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String       @unique

  // Curation settings
  relevanceThreshold        Float @default(6.0)
  maxArticlesPerEdition     Int   @default(10)
  vectorSimilarityThreshold Float @default(0.85)
  articleMaxAgeDays         Int   @default(7)

  // AI settings
  aiModel        String @default("claude-sonnet-4-20250514")
  embeddingModel String @default("text-embedding-ada-002")

  // Branding
  brandVoicePrompt String? @db.Text
  logoUrl          String?
  bannerUrl        String?
  primaryColor     String? @default("#0066cc")

  // Email settings
  fromName     String?
  replyToEmail String?

  updatedAt DateTime @updatedAt
}

// Brand voice profiles for Ghost Writer
model BrandVoice {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text
  isDefault   Boolean @default(false)

  // Voice configuration
  personality     String?  @db.Text // Personality description
  toneAttributes  String[] // confident, curious, helpful, etc.
  styleGuidelines String?  @db.Text
  dos             String[] // Things to do
  donts           String[] // Things to avoid
  greetings       String[] // Signature opening phrases
  closings        String[] // Signature closing phrases
  useEmoji        Boolean  @default(false)
  examplePhrases  Json? // { good: string[], bad: string[] }

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([isDefault])
}

// ==================== ARTICLE MODELS ====================

model Article {
  id          String   @id @default(cuid())
  sourceUrl   String
  title       String
  content     String   @db.Text
  author      String?
  publishedAt DateTime

  // AI-generated content
  embedding      Float[] // pgvector embedding
  relevanceScore Float?
  summary        String?  @db.Text
  category       String[]

  // Status tracking
  status ArticleStatus @default(PENDING_REVIEW)

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  editions EditionArticle[]

  @@unique([sourceUrl, organizationId]) // Same article can exist in different orgs
  @@index([status])
  @@index([relevanceScore(sort: Desc)])
  @@index([publishedAt(sort: Desc)])
  @@index([organizationId])
}

enum ArticleStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

// ==================== INTERNAL PROJECTS ====================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  team        String
  projectDate DateTime
  impact      String?  @db.Text
  imageUrl    String?
  featured    Boolean  @default(false)

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  editions EditionProject[]

  @@index([featured])
  @@index([organizationId])
}

// ==================== NEWSLETTER EDITIONS ====================

model Edition {
  id     String        @id @default(cuid())
  week   Int
  year   Int
  status EditionStatus @default(DRAFT)

  scheduledDate DateTime?
  finalizedAt   DateTime?
  sentAt        DateTime?

  // Ghost Writer generated content
  generatedContent Json? // AI-generated newsletter content
  generatedAt      DateTime?

  // Unlayer editor state
  editorDesignJson Json? // Saved Unlayer design for this edition
  templateId       String? // Template used as base

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articles EditionArticle[]
  projects EditionProject[]

  @@unique([week, year, organizationId]) // Same week/year can exist in different orgs
  @@index([status])
  @@index([organizationId])
}

enum EditionStatus {
  DRAFT
  FINALIZED
  SENT
}

// Join table: Edition <-> Articles (with ordering)
model EditionArticle {
  edition   Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)
  editionId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId String
  order     Int

  @@id([editionId, articleId])
  @@index([editionId, order])
}

// Join table: Edition <-> Projects (with ordering)
model EditionProject {
  edition   Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)
  editionId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  order     Int

  @@id([editionId, projectId])
  @@index([editionId, order])
}

// ==================== SUBSCRIBERS ====================

model Subscriber {
  id     String  @id @default(cuid())
  email  String
  name   String?
  active Boolean @default(true)

  // Preferences
  preferredLanguage String @default("en") // en, pt-pt, pt-br, es, ar
  preferredStyle    String @default("comprehensive") // executive, technical, comprehensive

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events EmailEvent[]

  @@unique([email, organizationId]) // Same email can subscribe to different orgs
  @@index([active])
  @@index([email])
  @@index([preferredLanguage, active])
  @@index([preferredStyle, active])
  @@index([organizationId])
}

// ==================== EMAIL TRACKING ====================

model EmailEvent {
  id String @id @default(cuid())

  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  subscriberId String

  editionId String
  eventType EmailEventType
  timestamp DateTime       @default(now())

  // Optional metadata (click URL, bounce reason, etc.)
  metadata Json?

  @@index([subscriberId, eventType])
  @@index([editionId, eventType])
  @@index([timestamp])
  @@index([eventType, timestamp])
  @@index([editionId, eventType, timestamp])
}

enum EmailEventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
}

// ==================== RSS SOURCES ====================

model RSSSource {
  id       String  @id @default(cuid())
  name     String
  url      String
  category String
  active   Boolean @default(true)

  lastFetchedAt DateTime?
  lastError     String?

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([url, organizationId]) // Same RSS can be used by different orgs
  @@index([active])
  @@index([organizationId])
}

// ==================== PLATFORM SETTINGS ====================

// Global platform settings (for platform-wide defaults)
model Settings {
  id                        String   @id @default("default")
  relevanceThreshold        Float    @default(6.0)
  maxArticlesPerEdition     Int      @default(10)
  vectorSimilarityThreshold Float    @default(0.85)
  articleMaxAgeDays         Int      @default(7)
  aiModel                   String   @default("claude-sonnet-4-20250514")
  embeddingModel            String   @default("text-embedding-ada-002")
  brandVoicePrompt          String?  @db.Text
  updatedAt                 DateTime @updatedAt
}

// Note: Per-organization settings are in OrgSettings model above

// ==================== CURATION JOBS ====================

model CurationJob {
  id          String            @id @default(cuid())
  status      CurationJobStatus @default(RUNNING)
  totalFound  Int               @default(0)
  processed   Int               @default(0)
  duplicates  Int               @default(0)
  lowScore    Int               @default(0)
  curated     Int               @default(0)
  errorsCount Int               @default(0)
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  durationMs  Int?
  logs        Json              @default("[]")

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@index([organizationId])
}

enum CurationJobStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== EMAIL TEMPLATES ====================

model EmailTemplate {
  id          String  @id @default(cuid())
  name        String
  description String?
  designJson  Json?
  html        String  @db.Text
  isActive    Boolean @default(false)
  isDefault   Boolean @default(false)

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
  @@index([organizationId])
}

// ==================== MEDIA ASSETS ====================

model MediaAsset {
  id       String @id @default(cuid())
  filename String
  url      String
  type     String // e.g., "image/png", "image/jpeg"
  size     Int // file size in bytes

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@index([organizationId])
}

// Note: BrandingSettings has been merged into OrgSettings for multi-tenant support

// ==================== TREND RADAR (WEB SEARCH) ====================

// Saved search topics/watchlists for ongoing monitoring
model SearchTopic {
  id          String  @id @default(cuid())
  name        String // Human-readable name: "DORA Regulation News"
  description String? @db.Text

  // Search configuration
  query       String  @db.Text // Natural language query
  queryExpanded String? @db.Text // AI-expanded query for better results
  providers   String[] @default(["tavily"]) // Which search providers to use

  // Scheduling
  schedule    SearchSchedule @default(MANUAL)
  lastRunAt   DateTime?
  nextRunAt   DateTime?

  // Filters
  timeRange   SearchTimeRange @default(WEEK)
  maxResults  Int @default(20)

  // Status
  isActive    Boolean @default(true)

  // Multi-tenant
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  results SearchResult[]

  @@index([organizationId])
  @@index([isActive])
  @@index([nextRunAt])
  @@index([schedule, isActive])
}

enum SearchSchedule {
  MANUAL // Only run on demand
  DAILY // Run once per day
  WEEKLY // Run once per week
}

enum SearchTimeRange {
  DAY // Last 24 hours
  WEEK // Last 7 days
  MONTH // Last 30 days
  YEAR // Last 365 days
}

// Individual search results from web searches
model SearchResult {
  id String @id @default(cuid())

  // Source information
  url         String
  title       String
  snippet     String  @db.Text
  content     String? @db.Text // Full content if available
  publishedAt DateTime?
  source      String? // Domain or publication name
  author      String?
  imageUrl    String?

  // Search metadata
  provider    String // Which provider found this: tavily, brave, etc.
  rawScore    Float? // Provider's relevance score

  // AI analysis
  aiScore         Float? // Claude relevance score (1-10)
  aiSummary       String? @db.Text
  aiTopics        String[] // Extracted topics
  aiSentiment     String? // positive, negative, neutral
  aiRelevanceNote String? @db.Text // Why it's relevant

  // Status
  status SearchResultStatus @default(NEW)
  importedArticleId String? // If imported to articles

  // Parent topic
  searchTopic   SearchTopic @relation(fields: [searchTopicId], references: [id], onDelete: Cascade)
  searchTopicId String

  createdAt DateTime @default(now())

  @@unique([url, searchTopicId]) // No duplicate URLs per topic
  @@index([searchTopicId])
  @@index([status])
  @@index([aiScore(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

enum SearchResultStatus {
  NEW // Just discovered
  REVIEWED // Human has seen it
  IMPORTED // Imported to articles
  DISMISSED // Marked as not relevant
}
