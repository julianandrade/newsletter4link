// Link AI Newsletter Engine - Database Schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// ==================== ARTICLE MODELS ====================

model Article {
  id        String   @id @default(cuid())
  sourceUrl String   @unique
  title     String
  content   String   @db.Text
  author    String?
  publishedAt DateTime

  // AI-generated content
  embedding      Float[]  // pgvector embedding
  relevanceScore Float?
  summary        String?  @db.Text
  category       String[]

  // Status tracking
  status    ArticleStatus @default(PENDING_REVIEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  editions EditionArticle[]

  @@index([status])
  @@index([relevanceScore(sort: Desc)])
  @@index([publishedAt(sort: Desc)])
}

enum ArticleStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

// ==================== INTERNAL PROJECTS ====================

model Project {
  id          String   @id @default(cuid())
  name        String
  description String   @db.Text
  team        String
  projectDate DateTime
  impact      String?  @db.Text
  imageUrl    String?
  featured    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  editions EditionProject[]

  @@index([featured])
}

// ==================== NEWSLETTER EDITIONS ====================

model Edition {
  id     String @id @default(cuid())
  week   Int
  year   Int
  status EditionStatus @default(DRAFT)

  finalizedAt DateTime?
  sentAt      DateTime?

  // Unlayer editor state
  editorDesignJson Json?    // Saved Unlayer design for this edition
  templateId       String?  // Template used as base

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articles EditionArticle[]
  projects EditionProject[]

  @@unique([week, year])
  @@index([status])
}

enum EditionStatus {
  DRAFT
  FINALIZED
  SENT
}

// Join table: Edition <-> Articles (with ordering)
model EditionArticle {
  edition   Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)
  editionId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId String
  order     Int

  @@id([editionId, articleId])
  @@index([editionId, order])
}

// Join table: Edition <-> Projects (with ordering)
model EditionProject {
  edition   Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)
  editionId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  order     Int

  @@id([editionId, projectId])
  @@index([editionId, order])
}

// ==================== SUBSCRIBERS ====================

model Subscriber {
  id     String  @id @default(cuid())
  email  String  @unique
  name   String?
  active Boolean @default(true)

  // Preferences
  preferredLanguage String @default("en") // en, pt-pt, pt-br, es, ar
  preferredStyle    String @default("comprehensive") // executive, technical, comprehensive

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events EmailEvent[]

  @@index([active])
  @@index([email])
  @@index([preferredLanguage, active])
  @@index([preferredStyle, active])
}

// ==================== EMAIL TRACKING ====================

model EmailEvent {
  id String @id @default(cuid())

  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  subscriberId String

  editionId String
  eventType EmailEventType
  timestamp DateTime @default(now())

  // Optional metadata (click URL, bounce reason, etc.)
  metadata Json?

  @@index([subscriberId, eventType])
  @@index([editionId, eventType])
  @@index([timestamp])
  @@index([eventType, timestamp])
  @@index([editionId, eventType, timestamp])
}

enum EmailEventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
}

// ==================== RSS SOURCES ====================

model RSSSource {
  id       String  @id @default(cuid())
  name     String
  url      String  @unique
  category String
  active   Boolean @default(true)

  lastFetchedAt DateTime?
  lastError     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}

// ==================== SETTINGS ====================

model Settings {
  id                        String   @id @default("default")
  relevanceThreshold        Float    @default(6.0)
  maxArticlesPerEdition     Int      @default(10)
  vectorSimilarityThreshold Float    @default(0.85)
  articleMaxAgeDays         Int      @default(7)
  aiModel                   String   @default("claude-sonnet-4-20250514")
  embeddingModel            String   @default("text-embedding-ada-002")
  brandVoicePrompt          String?  @db.Text
  updatedAt                 DateTime @updatedAt
}

// ==================== CURATION JOBS ====================

model CurationJob {
  id          String            @id @default(cuid())
  status      CurationJobStatus @default(RUNNING)
  totalFound  Int               @default(0)
  processed   Int               @default(0)
  duplicates  Int               @default(0)
  lowScore    Int               @default(0)
  curated     Int               @default(0)
  errorsCount Int               @default(0)
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  durationMs  Int?
  logs        Json              @default("[]")

  @@index([status])
  @@index([startedAt(sort: Desc)])
}

enum CurationJobStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== EMAIL TEMPLATES ====================

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  designJson  Json?
  html        String   @db.Text
  isActive    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
}

// ==================== BRANDING & MEDIA ====================

model BrandingSettings {
  id        String   @id @default("default")
  logoUrl   String?
  bannerUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MediaAsset {
  id        String   @id @default(cuid())
  filename  String
  url       String
  type      String   // e.g., "image/png", "image/jpeg"
  size      Int      // file size in bytes
  createdAt DateTime @default(now())

  @@index([type])
  @@index([createdAt(sort: Desc)])
}
